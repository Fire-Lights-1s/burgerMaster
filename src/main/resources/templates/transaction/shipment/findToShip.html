<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>출하등록 가능한 주문 선택</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/font.css">
    <link rel="stylesheet" href="/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">

    <!-- 스크립트 -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/dist/js/adminlte.min.js"></script>

</head>
<body>
<h3 class="text-center my-5">출하등록 가능한 주문 선택</h3>

<div class="item-list card-body col-12 mx-auto">
    <table class="table table-bordered table-hover dataTable dtr-inline">
        <tr class="bg-lightblue">
            <th class="text-center" style="width:15%;">수주번호</th>
            <th class="text-center" style="width:35%;">품목</th>
            <th class="text-center" style="width:15%;">출고번호</th>
            <th class="text-center" style="width:15%;">출고검품</th>
            <th class="text-center" style="width:20%;">납기일</th>
        </tr>
        <tr onclick="sendResult(this)" style="cursor: pointer;" th:each="item : ${toShip}">
            <td class="text-center" th:data-sale-id="${item.saleId}" th:text="${item.saleId}"></td>

            <td class="text-center" th:if="${item.itemCount > 1 }" th:data-items="${item.itemName} + ' 외 ' + ${item.itemCount - 1} + '건'"
                th:text="${#strings.length(item.itemName + ' 외 ' + (item.itemCount - 1) + '건') > 20
                            ? (item.itemName + ' 외 ' + (item.itemCount - 1) + '건').substring(0, 20) + '...'
                            : item.itemName + ' 외 ' + (item.itemCount - 1) + '건'}"></td>
            <td class="text-center" th:unless="${item.itemCount > 1 }" th:data-items="${item.itemName}" th:text="${item.itemName}"></td>

            <td class="text-center" th:data-outgoing="처리필요" th:text="처리필요"></td>
            <td class="text-center" th:data-quality="${item.qualityStatus}" th:text="${item.qualityStatus}"></td>
            <td class="text-center" th:data-duedate="${#dates.format(item.dueDate, 'yyyy-MM-dd')}" th:text="${#dates.format(item.dueDate, 'yyyy-MM-dd')}"></td>
            <input type="hidden" id="franchiseCode" th:value="${item.franchiseCode}">
            <input type="hidden" id="franchiseName" th:value="${item.franchiseName}">
            <input type="hidden" id="orderDate" th:value="${#dates.format(item.orderDate, 'yyyy-MM-dd')}">
            <input type="hidden" id="saleItems" th:value="${item.saleItems}">
            <input type="hidden" id="totalPrice" th:value="${item.totalPrice}">
            <input type="hidden" id="quantity" th:value="${item.itemCount}">
        </tr>
    </table>
</div>

<script th:inline="javascript">
    // 선택한 항목 정보 넘겨주고 팝업창 닫기
    function sendResult(row) {
        var saleId = row.querySelector('[data-sale-id]').getAttribute('data-sale-id');
        var items = row.querySelector('[data-items]').getAttribute('data-items');
        var quality = row.querySelector('[data-quality]').getAttribute('data-quality');
        var franchiseCode = row.querySelector('#franchiseCode').value;
        var franchiseName = row.querySelector('#franchiseName').value;
        var orderDate = row.querySelector('#orderDate').value;
        var dueDate = row.querySelector('[data-duedate]').getAttribute('data-duedate');
        var saleItems = row.querySelector('#saleItems').value;
        var totalPrice = row.querySelector('#totalPrice').value;
        var quantity = row.querySelector('#quantity').value;

        // saleItems 문자열을 JSON에 맞는 형식으로 변환
        try {
            // 1. 불필요한 텍스트 제거: "SaleItemsDTO(...)" 부분을 "{...}"으로 변환
            saleItems = saleItems
                .replace(/SaleItemsDTO\(/g, '{')  // "SaleItemsDTO("를 '{'로
                .replace(/\)/g, '}')               // ")"를 '}'로
                .replace(/(\w+)=/g, '"$1":');      // "key=" 형태를 '"key":'로 변환하여 JSON 속성 형식으로

            // 2. JSON 파싱
            saleItems = JSON.parse(saleItems);
        } catch (e) {
            console.error("saleItems 파싱 중 오류 발생:", e);
        }

        window.opener.setToShip(saleId, items, quality, franchiseCode, franchiseName, orderDate, dueDate, saleItems, totalPrice, quantity);
        window.close();
    }
</script>


</body>
</html>